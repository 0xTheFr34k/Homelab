
version: "3"

vars:
  USERNAME: 0xTheFr34k
  REPO: Homelab
  PATH: kubernetes/clusters/staging
  BRANCH: master

tasks:
  bootstrap:
    cmds:
      - flux bootstrap github --token-auth --owner="{{.USERNAME}}" --repository="{{.REPO}}" --branch="{{.BRANCH}}" --path="{{.PATH}}" --personal
    silent: true

  status:
    aliases: ["sts"]
    cmds:
      - flux get all -A
    silent: true

  kustomization:
    aliases: ["kst"]
    cmds:
      - flux get kustomization {{if .CLI_ARGS}} {{.CLI_ARGS}} {{end}}
    silent: true

  sources:
    aliases: ["src"]
    cmds:
      - flux get sources git -A
    silent: true

  reconcile:
    aliases: ["rec"]
    cmds:
      - flux reconcile kustomization $(kubectl get kustomization -A | awk 'NR>1 {print $2}' | fzf --header=kustomizations) --with-source -n $(kubectl get ns -A | awk 'NR>1 {print $1}' | fzf --header=namespaces)
    # desc: flux:rec -- name -n namespace
    silent: true

  sync:
    cmds:
      - flux reconcile source git  $(flux get sources git -A | awk 'NR>1 {print $2}' | fzf)
    silent: true
